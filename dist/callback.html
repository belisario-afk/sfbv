<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Spotify Auth Callback</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0b0f1a; color: #e6ecff; display: grid; place-items: center; height: 100vh; }
      .card { background: #121829; border: 1px solid #1b2542; padding: 24px; border-radius: 12px; }
      code { color: #a78bfa; }
    </style>
  </head>
  <body>
    <div class="card">
      <div id="status">Completing Spotify authenticationâ€¦</div>
    </div>
    <script>
      (async function() {
        try {
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          const state = params.get('state');
          const error = params.get('error');
          if (error) {
            document.getElementById('status').textContent = 'Error: ' + error;
            return;
          }
          const storedState = localStorage.getItem('spotify_auth_state');
          const verifier = localStorage.getItem('spotify_code_verifier');
          const clientId = localStorage.getItem('spotify_client_id') || '927fda6918514f96903e828fcd6bb576';
          const redirectUri = `${location.origin}/sfbv/callback`;

          if (!code || !verifier || !clientId || state !== storedState) {
            document.getElementById('status').textContent = 'Invalid auth state. Please retry.';
            return;
          }

          const body = new URLSearchParams();
          body.set('client_id', clientId);
          body.set('grant_type', 'authorization_code');
          body.set('code', code);
          body.set('redirect_uri', redirectUri);
          body.set('code_verifier', verifier);

          const res = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
          });
          const tokens = await res.json();
          if (!res.ok) {
            document.getElementById('status').textContent = 'Token exchange failed: ' + JSON.stringify(tokens);
            return;
          }

          const now = Date.now();
          const stored = {
            ...tokens,
            obtained_at: now,
            expires_at: now + (tokens.expires_in * 1000)
          };
          localStorage.setItem('spotify_tokens', JSON.stringify(stored));
          // Clean temp storage
          localStorage.removeItem('spotify_code_verifier');
          localStorage.removeItem('spotify_auth_state');

          // Redirect back to app
          window.location.replace(`${location.origin}/sfbv/`);
        } catch (e) {
          document.getElementById('status').textContent = 'Unhandled error: ' + (e && e.message ? e.message : String(e));
        }
      })();
    </script>
  </body>
</html>